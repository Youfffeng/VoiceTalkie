//
//  AppDelegate.swift
//  VoiceTalkie
//
//  Created by Qoder on 11/18/25.
//

import Cocoa
import SwiftUI

class AppDelegate: NSObject, NSApplicationDelegate {
    private var statusItem: NSStatusItem?
    private var popover: NSPopover?
    private let coordinator = VoiceTalkieCoordinator.shared
    private var settingsWindow: NSWindow?
    private var recordingIndicatorWindow: RecordingIndicatorWindow?
    
    func applicationDidFinishLaunching(_ notification: Notification) {
        // åˆ›å»ºèœå•æ å›¾æ ‡
        setupStatusBarItem()
        
        // åˆ›å»ºå½•éŸ³æŒ‡ç¤ºå™¨çª—å£
        recordingIndicatorWindow = RecordingIndicatorWindow()
        
        // éšè— Dock å›¾æ ‡ï¼ˆå¯é€‰ï¼Œå¦‚æœåªæƒ³è¦èœå•æ åº”ç”¨ï¼‰
        NSApp.setActivationPolicy(.accessory)
        
        // ğŸ” è¯Šæ–­ï¼šæ£€æŸ¥åº”ç”¨ä¿¡æ¯
        Task {
            print("ğŸ” [AppDelegate] ========== åº”ç”¨è¯Šæ–­ä¿¡æ¯ ==========")
            print("ğŸ“± Bundle ID: \(Bundle.main.bundleIdentifier ?? "æœªçŸ¥")")
            print("ğŸ“‚ Bundle Path: \(Bundle.main.bundlePath)")
            print("ğŸ†” Process ID: \(ProcessInfo.processInfo.processIdentifier)")
            
            // æ£€æŸ¥ Info.plist ä¸­çš„æƒé™æè¿°
            if let micDesc = Bundle.main.object(forInfoDictionaryKey: "NSMicrophoneUsageDescription") as? String {
                print("âœ… NSMicrophoneUsageDescription: \(micDesc)")
            } else {
                print("âŒ NSMicrophoneUsageDescription æœªé…ç½®ï¼")
            }
            
            print("ğŸ” [AppDelegate] ========================================")
        }
        
        // åˆå§‹åŒ–åè°ƒå™¨
        Task {
            await coordinator.initialize()
        }
        
        // ç›‘å¬å½•éŸ³çŠ¶æ€å˜åŒ–ï¼Œæ˜¾ç¤º/éšè—æŒ‡ç¤ºå™¨
        observeCoordinatorState()
    }
    
    private func setupStatusBarItem() {
        // åˆ›å»ºçŠ¶æ€æ é¡¹ç›®
        statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.variableLength)
        
        guard let button = statusItem?.button else {
            print("Failed to create status bar button")
            return
        }
        
        // è®¾ç½®å›¾æ ‡ï¼ˆæš‚æ—¶ä½¿ç”¨ SF Symbolï¼‰
        if let image = NSImage(systemSymbolName: "mic.fill", accessibilityDescription: "Voice Talkie") {
            image.isTemplate = true
            button.image = image
        }
        
        // åˆ›å»ºèœå•
        let menu = NSMenu()
        
        // å¼€å§‹å½•éŸ³èœå•é¡¹
        menu.addItem(NSMenuItem(
            title: NSLocalizedString("start_recording", comment: "Start Recording"),
            action: #selector(startRecording),
            keyEquivalent: ""
        ))
        
        menu.addItem(NSMenuItem.separator())
        
        // è®¾ç½®èœå•é¡¹
        menu.addItem(NSMenuItem(
            title: NSLocalizedString("settings", comment: "Settings"),
            action: #selector(openSettings),
            keyEquivalent: ","
        ))
        
        menu.addItem(NSMenuItem.separator())
        
        // é€€å‡ºèœå•é¡¹
        menu.addItem(NSMenuItem(
            title: NSLocalizedString("quit", comment: "Quit VoiceTalkie"),
            action: #selector(NSApplication.terminate(_:)),
            keyEquivalent: "q"
        ))
        
        statusItem?.menu = menu
    }
    
    @objc private func startRecording() {
        Task {
            if coordinator.isRecording {
                await coordinator.manualStopRecording()
            } else {
                await coordinator.manualStartRecording()
            }
        }
    }
    Â Â Â Â Â Â Â Â  Â Â 
    @objc private func openSettings() {
        // å¦‚æœè®¾ç½®çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º
        if let window = settingsWindow {
            window.makeKeyAndOrderFront(nil)
            NSApp.activate(ignoringOtherApps: true)
            return
        }
        
        // åˆ›å»ºè®¾ç½®çª—å£
        let settingsView = SettingsView()
        let hostingController = NSHostingController(rootView: settingsView)
        
        let window = NSWindow(
            contentRect: NSRect(x: 0, y: 0, width: 500, height: 600),
            styleMask: [.titled, .closable, .miniaturizable],
            backing: .buffered,
            defer: false
        )
        
        window.title = NSLocalizedString("settings_title", comment: "VoiceTalkie Settings")
        window.contentViewController = hostingController
        window.center()
        window.makeKeyAndOrderFront(nil)
        
        // æ¿€æ´»åº”ç”¨
        NSApp.activate(ignoringOtherApps: true)
        
        settingsWindow = window
    }
    
    // MARK: - Coordinator State Observation
    
    private func observeCoordinatorState() {
        // è§‚å¯Ÿå½•éŸ³çŠ¶æ€
        NotificationCenter.default.addObserver(
            forName: NSNotification.Name("VoiceTalkieRecordingStateChanged"),
            object: nil,
            queue: .main
        ) { [weak self] _ in
            self?.updateIndicatorVisibility()
        }
    }
    
    private func updateIndicatorVisibility() {
        if coordinator.isRecording || coordinator.isTranscribing {
            recordingIndicatorWindow?.show()
        } else if !coordinator.currentText.isEmpty {
            // æ˜¾ç¤ºè¯†åˆ«ç»“æœ 2 ç§’åéšè—
            DispatchQueue.main.asyncAfter(deadline: .now() + 2.0) { [weak self] in
                if !(self?.coordinator.isRecording ?? false) && !(self?.coordinator.isTranscribing ?? false) {
                    self?.recordingIndicatorWindow?.hide()
                }
            }
        } else {
            recordingIndicatorWindow?.hide()
        }
    }
}
